name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup:
    name: Install Bun & Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install with Bun
        run: bun install

  lint:
    name: ESLint (TypeScript & Next.js)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: ESLint
        run: bun run eslint . --ext .ts,.tsx

  semgrep:
    name: Semgrep SAST (Security & Code Smells)
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: returntocorp/semgrep
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Run Semgrep CE
        run: semgrep scan --config auto .
      # Optionally, if using Semgrep App Platform:
      # env:
      #   SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      # run: semgrep ci

  build:
    name: Build Next.js App
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun run build

  test_and_coverage:
    name: Tests & Coverage
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - name: Run tests with coverage
        run: bun run vitest --coverage --run
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
  msdo:
    name: Microsoft Security DevOps
    runs-on: ubuntu-latest
    needs: setup
    permissions:
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Run Microsoft Security DevOps
        uses: microsoft/security-devops-action@v1
        id: msdo
      - name: Upload results to Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.msdo.outputs.sarifFile }}

  sonarcloud:
    name: SonarCloud analysis
    if: github.event.pull_request.head.repo.read_only == false && secrets.SONAR_TOKEN
    runs-on: ubuntu-latest
    needs: [setup, lint, test_and_coverage]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # required by SonarCloud
      - uses: oven-sh/setup-bun@v2
      - name: Run SonarCloud
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
